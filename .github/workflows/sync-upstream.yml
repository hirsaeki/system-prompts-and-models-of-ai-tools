name: Auto sync fork with upstream

on:
  schedule:
    - cron: '0 18 * * *'
  workflow_dispatch:

permissions:
  contents: write

env:
  # 必要ならここに "owner/repo" を直書きして上書きできる
  # 空なら自動判別
  UPSTREAM: ""

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Checkout fork
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect upstream repo
        id: detect
        env:
          GITHUB_TOKEN: ${{ github.token }}
          OVERRIDE_UPSTREAM: ${{ env.UPSTREAM }}
        run: |
          # 1. 明示指定があればそれを使う
          if [ -n "$OVERRIDE_UPSTREAM" ]; then
            echo "upstream=$OVERRIDE_UPSTREAM" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # 2. API から parent を取得
          repo="${GITHUB_REPOSITORY}"   # owner/repo
          json=$(curl -s \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${repo}")

          upstream=$(echo "$json" | jq -r '.parent.full_name // empty')
          if [ -z "$upstream" ] || [ "$upstream" = "null" ]; then
            echo "No upstream (parent) detected. This repo may not be a fork."
            # upstream がない場合は何もせず成功終了にしておく
            exit 0
          fi

          default_branch=$(echo "$json" | jq -r '.default_branch // empty')
          if [ -z "$default_branch" ] || [ "$default_branch" = "null" ]; then
            # フォーク側の default_branch にフォールバック
            default_branch="${GITHUB_DEFAULT_BRANCH}"
          fi

          echo "upstream=$upstream" >> "$GITHUB_OUTPUT"
          echo "default_branch=$default_branch" >> "$GITHUB_OUTPUT"
        env:
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}

      - name: Sync default branch
        if: steps.detect.outputs.upstream != ''
        env:
          UPSTREAM_REPO: ${{ steps.detect.outputs.upstream }}
          TARGET_BRANCH: ${{ steps.detect.outputs.default_branch }}
        run: |
          echo "Upstream: $UPSTREAM_REPO"
          echo "Default branch: $TARGET_BRANCH"

          git remote add upstream "https://github.com/${UPSTREAM_REPO}.git"
          git fetch upstream

          git checkout "$TARGET_BRANCH"

          # まず fast-forward を試す
          git merge --ff-only "upstream/${TARGET_BRANCH}" || {
            echo "Fast-forward failed, attempting normal merge."
            git merge "upstream/${TARGET_BRANCH}"
          }

          git push origin "$TARGET_BRANCH"
