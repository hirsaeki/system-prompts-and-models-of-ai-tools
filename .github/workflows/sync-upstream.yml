name: Sync fork with upstream

on:
  schedule:
    - cron: "0 18 * * *" # UTC。JSTだと毎日03:00
  workflow_dispatch:

permissions:
  contents: write

env:
  # 任意: "owner/repo" を直書きすると upstream 自動判別より優先
  UPSTREAM: ""

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set Git identity
        # Ensure git has a valid committer before any merges/pushes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Detect upstream
        id: detect
        env:
          GITHUB_TOKEN: ${{ github.token }}
          OVERRIDE_UPSTREAM: ${{ env.UPSTREAM }}
          FORK_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
        run: |
          if [ -n "$OVERRIDE_UPSTREAM" ]; then
            echo "upstream=$OVERRIDE_UPSTREAM" >> "$GITHUB_OUTPUT"
            echo "branch=$FORK_DEFAULT_BRANCH" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          repo="${GITHUB_REPOSITORY}"
          json=$(curl -s \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${repo}")

          upstream=$(echo "$json" | jq -r '.parent.full_name // empty')
          upstream_branch=$(echo "$json" | jq -r '.parent.default_branch // empty')

          if [ -z "$upstream" ] || [ "$upstream" = "null" ]; then
            echo "This repo does not look like a fork (no parent)."
            exit 0
          fi

          if [ -z "$upstream_branch" ] || [ "$upstream_branch" = "null" ]; then
            upstream_branch="$FORK_DEFAULT_BRANCH"
          fi

          echo "upstream=$upstream" >> "$GITHUB_OUTPUT"
          echo "branch=$upstream_branch" >> "$GITHUB_OUTPUT"

      - name: Sync (merge; fail on conflict)
        if: steps.detect.outputs.upstream != ''
        env:
          UPSTREAM_REPO: ${{ steps.detect.outputs.upstream }}
          TARGET_BRANCH: ${{ steps.detect.outputs.branch }}
        run: |
          git config --local user.name  "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
          echo "Upstream: $UPSTREAM_REPO"
          echo "Branch: $TARGET_BRANCH"
          git config --local --get user.name
          git config --local --get user.email
      
          git remote add upstream "https://github.com/${UPSTREAM_REPO}.git"
          git fetch upstream
          git checkout "$TARGET_BRANCH"
      
          if ! git merge --ff-only "upstream/${TARGET_BRANCH}"; then
            git merge --no-edit "upstream/${TARGET_BRANCH}"
          fi
      
          git push origin "$TARGET_BRANCH"
